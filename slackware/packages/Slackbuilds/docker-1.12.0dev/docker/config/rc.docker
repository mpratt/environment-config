#!/bin/sh
# /etc/rc.d/rc.docker

BASE=docker
DOCKER=/usr/bin/${BASE}
DOCKER_PIDFILE=/var/run/${BASE}-daemon.pid
DOCKER_SOCKET="/var/run/docker.sock"
DOCKER_LOG=/var/log/docker.log
DOCKER_STORAGE_DRIVER=${DOCKER_STORAGE_DRIVER:-overlay}
DOCKER_OPTS=""

if [ -f /etc/default/${BASE} ]; then
    . /etc/default/${BASE}
fi

# Check docker is present
if [ ! -x ${DOCKER} ]; then
    echo "${DOCKER} not present or not executable"
    exit 1
fi

docker_start() {
    echo "starting ${BASE} daemon ..."

    # If there is an old PID file (no docker running), clean it up:
    if [ -r ${DOCKER_PIDFILE} ]; then
        if ! ps axc | grep docker 1> /dev/null 2> /dev/null ; then
            echo "Cleaning up old ${DOCKER_PIDFILE}."
            rm -f ${DOCKER_PIDFILE}
        fi
    fi

    ${DOCKER} daemon -D --pidfile="${DOCKER_PIDFILE}" --storage-driver=${DOCKER_STORAGE_DRIVER} ${DOCKER_OPTS} >> ${DOCKER_LOG} 2>&1 &
}

# Stop docker:
docker_stop() {
    echo "stopping ${BASE} ..."
    if [ -r ${DOCKER_PIDFILE} ]; then
        kill $(cat ${DOCKER_PIDFILE})
        [ -f "${DOCKER_PIDFILE}" ] && rm -rf ${DOCKER_PIDFILE}
    fi
}

# Restart docker:
docker_restart() {
    docker_stop
    docker_start
}

case "$1" in
    'start')
        docker_start
        ;;
    'stop')
        docker_stop
        ;;
    'restart')
        docker_restart
        ;;
    'status')
        if [ -f ${DOCKER_PIDFILE} ] && ps -o cmd $(cat ${DOCKER_PIDFILE}) | grep -q ${BASE} ; then
            echo "status of ${BASE}: running"
        else
            echo "status of ${BASE}: stopped"
        fi
        ;;
    *)
        echo "usage $0 start|stop|restart|status"
esac

exit 0
